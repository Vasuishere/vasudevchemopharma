{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - Vasudev Chemo Pharma{% endblock %}
{% block meta_description %}{{ product.description }}{% endblock %}
{% block canonical %}https://vasudevchemopharma.com/products/{{ product.slug }}/{% endblock %}
{% block og_title %}{{ product.name }} – Vasudev Chemo Pharma{% endblock %}
{% block og_description %}{{ product.description }}{% endblock %}
{% block og_url %}https://vasudevchemopharma.com/products/{{ product.slug }}/{% endblock %}
{% block og_type %}product{% endblock %}
{% block og_extra %}{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="breadcrumb-bar">
    <div class="container">
        <a href="{% url 'index' %}">Home</a>
        <span class="sep"><i class="bi bi-chevron-right"></i></span>
        <a href="{% url 'products' %}">Products</a>
        <span class="sep"><i class="bi bi-chevron-right"></i></span>
        <span class="current">{{ product.name }}</span>
    </div>
</div>

<!-- Hero Section -->
<section class="pd-hero">
    <div class="container">
        <div class="hero-grid">
            <!-- Image Gallery -->
            <div class="gallery-wrap">
                <div class="gallery-main" id="mainGallery">
                    {% if product.primary_image %}
                        <img src="{{ product.primary_image.image.url }}"
                             alt="{{ product.primary_image.alt_text|default:product.name }}"
                             id="mainImg" class="img-fluid">
                    {% elif product.structure_image %}
                        <img src="{{ product.structure_image.url }}"
                             alt="{{ product.name }} structure"
                             id="mainImg" class="img-fluid">
                    {% else %}
                        <div class="gallery-icon-placeholder">{{ product.icon|default:"?" }}</div>
                    {% endif %}
                </div>
                {% if product.images.count > 1 %}
                <div class="gallery-thumbs">
                    {% for img in product.images.all %}
                    <div class="thumb {% if forloop.first %}active{% endif %}"
                         onclick="switchImage(this, '{{ img.image.url|escapejs }}', '{{ img.alt_text|default:product.name|escapejs }}')">
                        <img src="{{ img.image.url }}" alt="{{ img.alt_text|default:'Thumbnail' }}" loading="lazy" width="72" height="72">
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Product Info -->
            <div class="hero-info">
                <div class="category-badge">{{ product.category.label }}</div>
                <h1>{{ product.name }}</h1>

                {% if product.brand_name or product.manufacturer %}
                <p class="brand-line">
                    {% if product.brand_name %}<strong>{{ product.brand_name }}</strong>{% endif %}
                    {% if product.brand_name and product.manufacturer %} &mdash; {% endif %}
                    {% if product.manufacturer %}by {{ product.manufacturer }}{% endif %}
                </p>
                {% endif %}

                <p class="short-desc">{{ product.description }}</p>

                <!-- Key Facts -->
                <div class="key-facts">
                    {% if product.cas_number %}
                    <div class="key-fact"><i class="bi bi-hash"></i><strong>CAS:</strong> {{ product.cas_number }}</div>
                    {% endif %}
                    {% if product.sku %}
                    <div class="key-fact"><i class="bi bi-upc-scan"></i><strong>SKU:</strong> {{ product.sku }}</div>
                    {% endif %}
                    {% if product.hs_code %}
                    <div class="key-fact"><i class="bi bi-box-seam"></i><strong>HS:</strong> {{ product.hs_code }}</div>
                    {% endif %}
                    {% if product.molecular_formula %}
                    <div class="key-fact"><i class="bi bi-diagram-3"></i><strong>Formula:</strong> {{ product.molecular_formula }}</div>
                    {% endif %}
                    {% if product.country_of_origin %}
                    <div class="key-fact"><i class="bi bi-globe"></i>{{ product.country_of_origin }}</div>
                    {% endif %}
                    {% if product.purity_grade %}
                    <div class="key-fact"><i class="bi bi-award"></i>{{ product.purity_grade }}</div>
                    {% endif %}
                </div>

                <!-- Grade Badges -->
                {% if product.available_grades %}
                <div class="grade-badges">
                    {% if product.is_technical_grade %}<span class="grade-badge technical">Technical Grade</span>{% endif %}
                    {% if product.is_industrial_grade %}<span class="grade-badge industrial">Industrial Grade</span>{% endif %}
                    {% if product.is_analytical_grade %}<span class="grade-badge analytical">Analytical Grade</span>{% endif %}
                    {% if product.is_pharma_grade %}<span class="grade-badge pharma">Pharma Grade</span>{% endif %}
                </div>
                {% endif %}

                <!-- CTAs -->
                <div class="cta-row">
                    <a href="/#contact" class="cta-btn cta-primary">
                        <i class="bi bi-envelope"></i> Request a Quote
                    </a>
                    {% if product.sds_file %}
                    <a href="{{ product.sds_file.url }}" class="cta-btn cta-outline" target="_blank" rel="noopener">
                        <i class="bi bi-download"></i> Download SDS
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Tabs + Sidebar -->
<section class="tab-section">
    <div class="container">
        <div class="tab-layout">
            <!-- Main Content (tabs) -->
            <div>
                <!-- Tab Navigation -->
                <div class="htab-nav" role="tablist">
                    <button class="nav-link active" data-tab="overview" role="tab" id="tab-btn-overview" aria-selected="true" aria-controls="tab-overview">
                        <i class="bi bi-info-circle"></i> Overview
                    </button>
                    {% if product.has_chemical_identification or product.has_physical_properties or product.specs.all %}
                    <button class="nav-link" data-tab="specifications" role="tab" id="tab-btn-specifications" aria-selected="false" aria-controls="tab-specifications">
                        <i class="bi bi-clipboard-data"></i> Specifications
                    </button>
                    {% endif %}
                    {% if product.has_safety_info %}
                    <button class="nav-link" data-tab="safety" role="tab" id="tab-btn-safety" aria-selected="false" aria-controls="tab-safety">
                        <i class="bi bi-shield-exclamation"></i> Safety
                    </button>
                    {% endif %}
                    {% if product.has_packaging_info %}
                    <button class="nav-link" data-tab="packaging" role="tab" id="tab-btn-packaging" aria-selected="false" aria-controls="tab-packaging">
                        <i class="bi bi-box-seam"></i> Packaging
                    </button>
                    {% endif %}
                    {% if product.documents.all %}
                    <button class="nav-link" data-tab="documents" role="tab" id="tab-btn-documents" aria-selected="false" aria-controls="tab-documents">
                        <i class="bi bi-file-earmark-text"></i> Documents
                    </button>
                    {% endif %}
                    {% if product.pricing_tiers.all %}
                    <button class="nav-link" data-tab="pricing" role="tab" id="tab-btn-pricing" aria-selected="false" aria-controls="tab-pricing">
                        <i class="bi bi-currency-dollar"></i> Pricing
                    </button>
                    {% endif %}
                    {% if product.faqs.all %}
                    <button class="nav-link" data-tab="faq" role="tab" id="tab-btn-faq" aria-selected="false" aria-controls="tab-faq">
                        <i class="bi bi-question-circle"></i> FAQ
                    </button>
                    {% endif %}
                </div>

                <!-- Tab Content -->
                <div class="tab-content-area">
                    <!-- OVERVIEW TAB -->
                    <div class="tab-pane active" id="tab-overview" role="tabpanel" aria-labelledby="tab-btn-overview" tabindex="0">
                        {% if product.full_description %}
                        <div class="content-card">
                            <h3><i class="bi bi-text-paragraph"></i> Product Description</h3>
                            <div class="long-text">{{ product.full_description|linebreaksbr }}</div>
                        </div>
                        {% endif %}
                        {% if product.has_application_info %}
                        <div class="content-card">
                            <h3><i class="bi bi-gear"></i> Application &amp; Usage</h3>
                            <table class="data-table">
                                {% if product.primary_applications %}
                                <tr><td class="dt-label">Primary Applications</td><td class="dt-value">{{ product.primary_applications|linebreaksbr }}</td></tr>
                                {% endif %}
                                {% if product.industry_usage %}
                                <tr><td class="dt-label">Industry Usage</td><td class="dt-value">{{ product.industry_usage|linebreaksbr }}</td></tr>
                                {% endif %}
                                {% if product.recommended_dosage %}
                                <tr><td class="dt-label">Recommended Dosage</td><td class="dt-value">{{ product.recommended_dosage|linebreaksbr }}</td></tr>
                                {% endif %}
                                {% if product.compatible_materials %}
                                <tr><td class="dt-label">Compatible Materials</td><td class="dt-value">{{ product.compatible_materials|linebreaksbr }}</td></tr>
                                {% endif %}
                                {% if product.shelf_life %}
                                <tr><td class="dt-label">Shelf Life</td><td class="dt-value">{{ product.shelf_life }}</td></tr>
                                {% endif %}
                            </table>
                        </div>
                        {% endif %}
                        {% if product.pack_sizes_list %}
                        <div class="content-card">
                            <h3><i class="bi bi-boxes"></i> Available Pack Sizes</h3>
                            <div class="tag-list">
                                {% for ps in product.pack_sizes_list %}
                                <span class="tag-item">{{ ps }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- SPECIFICATIONS TAB -->
                    {% if product.has_chemical_identification or product.has_physical_properties or product.specs.all %}
                    <div class="tab-pane" id="tab-specifications" role="tabpanel" aria-labelledby="tab-btn-specifications" tabindex="0">
                        {% if product.has_chemical_identification %}
                        <div class="content-card">
                            <h3><i class="bi bi-droplet-half"></i> Chemical Identification</h3>
                            <table class="data-table">
                                {% if product.common_names %}
                                <tr>
                                    <td class="dt-label">Common Names / Synonyms</td>
                                    <td class="dt-value">
                                        <div class="tag-list">
                                            {% for n in product.common_names_list %}
                                            <span class="tag-item">{{ n }}</span>
                                            {% endfor %}
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% if product.molecular_formula %}
                                <tr><td class="dt-label">Molecular Formula</td><td class="dt-value" style="font-family:monospace;font-size:1rem">{{ product.molecular_formula }}</td></tr>
                                {% endif %}
                                {% if product.molecular_weight %}
                                <tr><td class="dt-label">Molecular Weight</td><td class="dt-value">{{ product.molecular_weight }}</td></tr>
                                {% endif %}
                                {% if product.purity_grade %}
                                <tr><td class="dt-label">Purity / Grade</td><td class="dt-value">{{ product.purity_grade }}</td></tr>
                                {% endif %}
                                {% if product.un_number %}
                                <tr><td class="dt-label">UN Number</td><td class="dt-value">{{ product.un_number }}</td></tr>
                                {% endif %}
                            </table>
                            {% if product.structure_image %}
                            <hr class="section-divider">
                            <h3 style="font-size:1.05rem"><i class="bi bi-bezier2"></i> Structure Formula</h3>
                            <img src="{{ product.structure_image.url }}" alt="{{ product.name }} structure"
                                 loading="lazy" class="img-fluid" style="max-width:320px;border-radius:10px;border:1px solid #e2e8f0;padding:.5rem;background:#fff">
                            {% endif %}
                        </div>
                        {% endif %}
                        {% if product.has_physical_properties %}
                        <div class="content-card">
                            <h3><i class="bi bi-thermometer-half"></i> Physical &amp; Chemical Properties</h3>
                            <table class="data-table">
                                {% if product.appearance %}<tr><td class="dt-label">Appearance</td><td class="dt-value">{{ product.appearance }}</td></tr>{% endif %}
                                {% if product.odor %}<tr><td class="dt-label">Odor</td><td class="dt-value">{{ product.odor }}</td></tr>{% endif %}
                                {% if product.density %}<tr><td class="dt-label">Density</td><td class="dt-value">{{ product.density }}</td></tr>{% endif %}
                                {% if product.melting_point %}<tr><td class="dt-label">Melting Point</td><td class="dt-value">{{ product.melting_point }}</td></tr>{% endif %}
                                {% if product.boiling_point %}<tr><td class="dt-label">Boiling Point</td><td class="dt-value">{{ product.boiling_point }}</td></tr>{% endif %}
                                {% if product.solubility %}<tr><td class="dt-label">Solubility</td><td class="dt-value">{{ product.solubility|linebreaksbr }}</td></tr>{% endif %}
                                {% if product.ph_value %}<tr><td class="dt-label">pH</td><td class="dt-value">{{ product.ph_value }}</td></tr>{% endif %}
                                {% if product.vapor_pressure %}<tr><td class="dt-label">Vapor Pressure</td><td class="dt-value">{{ product.vapor_pressure }}</td></tr>{% endif %}
                                {% if product.viscosity %}<tr><td class="dt-label">Viscosity</td><td class="dt-value">{{ product.viscosity }}</td></tr>{% endif %}
                                {% if product.refractive_index %}<tr><td class="dt-label">Refractive Index</td><td class="dt-value">{{ product.refractive_index }}</td></tr>{% endif %}
                                {% if product.stability_reactivity %}<tr><td class="dt-label">Stability / Reactivity</td><td class="dt-value">{{ product.stability_reactivity|linebreaksbr }}</td></tr>{% endif %}
                            </table>
                        </div>
                        {% endif %}
                        {% if product.specs.all %}
                        <div class="content-card">
                            <h3><i class="bi bi-list-check"></i> Additional Specifications</h3>
                            <table class="data-table">
                                {% for spec in product.specs.all %}
                                <tr><td class="dt-label">{{ spec.label }}</td><td class="dt-value">{{ spec.value }}</td></tr>
                                {% endfor %}
                            </table>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- SAFETY TAB -->
                    {% if product.has_safety_info %}
                    <div class="tab-pane" id="tab-safety" role="tabpanel" aria-labelledby="tab-btn-safety" tabindex="0">
                        <div class="content-card">
                            <h3><i class="bi bi-shield-exclamation"></i> Safety &amp; Regulatory</h3>
                            {% if product.signal_word %}
                            <div style="margin-bottom:1.2rem">
                                {% if product.signal_word == "Danger" %}
                                <span class="signal-danger"><i class="bi bi-exclamation-triangle-fill"></i> DANGER</span>
                                {% else %}
                                <span class="signal-warning"><i class="bi bi-exclamation-triangle"></i> WARNING</span>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% if product.hazard_pictograms_list %}
                            <div class="hazard-pictograms">
                                {% for pic in product.hazard_pictograms_list %}
                                <span class="pictogram-badge"><i class="bi bi-diamond-fill"></i> {{ pic }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% if product.ghs_classification %}
                            <div style="margin-bottom:1rem">
                                <strong style="font-size:.9rem;color:#2d3748">GHS Classification</strong>
                                <p class="long-text" style="margin-top:.3rem">{{ product.ghs_classification|linebreaksbr }}</p>
                            </div>
                            {% endif %}
                            {% if product.hazard_statements_list %}
                            <div style="margin-bottom:1rem">
                                <strong style="font-size:.9rem;color:#2d3748">Hazard Statements</strong>
                                <div style="margin-top:.4rem">
                                    {% for h in product.hazard_statements_list %}<span class="h-code">{{ h }}</span>{% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            {% if product.precautionary_statements_list %}
                            <div style="margin-bottom:1rem">
                                <strong style="font-size:.9rem;color:#2d3748">Precautionary Statements</strong>
                                <div style="margin-top:.4rem">
                                    {% for p in product.precautionary_statements_list %}<span class="p-code">{{ p }}</span>{% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            <hr class="section-divider">
                            <table class="data-table">
                                {% if product.flash_point %}<tr><td class="dt-label">Flash Point</td><td class="dt-value">{{ product.flash_point }}</td></tr>{% endif %}
                                {% if product.transport_class %}<tr><td class="dt-label">Transport Class</td><td class="dt-value">{{ product.transport_class }}</td></tr>{% endif %}
                                {% if product.packing_group %}<tr><td class="dt-label">Packing Group</td><td class="dt-value">{{ product.packing_group }}</td></tr>{% endif %}
                                {% if product.un_number %}<tr><td class="dt-label">UN Number</td><td class="dt-value">{{ product.un_number }}</td></tr>{% endif %}
                                {% if product.iso_certification %}<tr><td class="dt-label">ISO Certification</td><td class="dt-value">{{ product.iso_certification }}</td></tr>{% endif %}
                            </table>
                        </div>
                        {% if product.storage_conditions or product.handling_instructions or product.disposal_information or product.regulatory_compliance %}
                        <div class="content-card">
                            <h3><i class="bi bi-info-square"></i> Handling &amp; Storage</h3>
                            <table class="data-table">
                                {% if product.storage_conditions %}<tr><td class="dt-label">Storage Conditions</td><td class="dt-value">{{ product.storage_conditions|linebreaksbr }}</td></tr>{% endif %}
                                {% if product.handling_instructions %}<tr><td class="dt-label">Handling Instructions</td><td class="dt-value">{{ product.handling_instructions|linebreaksbr }}</td></tr>{% endif %}
                                {% if product.disposal_information %}<tr><td class="dt-label">Disposal Information</td><td class="dt-value">{{ product.disposal_information|linebreaksbr }}</td></tr>{% endif %}
                                {% if product.regulatory_compliance %}<tr><td class="dt-label">Regulatory Compliance</td><td class="dt-value">{{ product.regulatory_compliance|linebreaksbr }}</td></tr>{% endif %}
                            </table>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- PACKAGING TAB -->
                    {% if product.has_packaging_info %}
                    <div class="tab-pane" id="tab-packaging" role="tabpanel" aria-labelledby="tab-btn-packaging" tabindex="0">
                        <div class="content-card">
                            <h3><i class="bi bi-box-seam"></i> Packaging &amp; Logistics</h3>
                            <table class="data-table">
                                {% if product.packaging_type %}<tr><td class="dt-label">Packaging Type</td><td class="dt-value">{{ product.packaging_type }}</td></tr>{% endif %}
                                {% if product.net_weight %}<tr><td class="dt-label">Net Weight</td><td class="dt-value">{{ product.net_weight }}</td></tr>{% endif %}
                                {% if product.gross_weight %}<tr><td class="dt-label">Gross Weight</td><td class="dt-value">{{ product.gross_weight }}</td></tr>{% endif %}
                                {% if product.dimensions %}<tr><td class="dt-label">Dimensions</td><td class="dt-value">{{ product.dimensions }}</td></tr>{% endif %}
                                {% if product.moq %}<tr><td class="dt-label">Minimum Order Qty</td><td class="dt-value">{{ product.moq }}</td></tr>{% endif %}
                                {% if product.lead_time %}<tr><td class="dt-label">Lead Time</td><td class="dt-value">{{ product.lead_time }}</td></tr>{% endif %}
                                {% if product.dangerous_goods is not None %}
                                <tr>
                                    <td class="dt-label">Dangerous Goods</td>
                                    <td class="dt-value">
                                        {% if product.dangerous_goods %}
                                        <span style="color:#dc2626;font-weight:600"><i class="bi bi-exclamation-triangle-fill"></i> Yes</span>
                                        {% else %}
                                        <span style="color:#16a34a;font-weight:600"><i class="bi bi-check-circle-fill"></i> No</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endif %}
                                {% if product.shipping_restrictions %}<tr><td class="dt-label">Shipping Restrictions</td><td class="dt-value">{{ product.shipping_restrictions|linebreaksbr }}</td></tr>{% endif %}
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    <!-- DOCUMENTS TAB -->
                    {% if product.documents.all %}
                    <div class="tab-pane" id="tab-documents" role="tabpanel" aria-labelledby="tab-btn-documents" tabindex="0">
                        <div class="content-card">
                            <h3><i class="bi bi-file-earmark-text"></i> Documentation &amp; Certificates</h3>
                            <div class="doc-grid">
                                {% for doc in product.documents.all %}
                                <a href="{{ doc.file.url }}" class="doc-card" target="_blank" rel="noopener">
                                    <div class="doc-icon {{ doc.doc_type|lower }}">
                                        <i class="bi {{ doc.icon_class }}"></i>
                                    </div>
                                    <div class="doc-info">
                                        <div class="doc-title">{{ doc.title }}</div>
                                        <div class="doc-type">{{ doc.get_doc_type_display }}</div>
                                    </div>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- PRICING TAB -->
                    {% if product.pricing_tiers.all %}
                    <div class="tab-pane" id="tab-pricing" role="tabpanel" aria-labelledby="tab-btn-pricing" tabindex="0">
                        <div class="content-card">
                            <h3><i class="bi bi-currency-dollar"></i> Pricing Information</h3>
                            <div class="table-responsive-wrapper">
                                <table class="pricing-table">
                                    <thead>
                                        <tr>
                                            <th>Min Quantity</th>
                                            <th>Max Quantity</th>
                                            <th>Price / Info</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for tier in product.pricing_tiers.all %}
                                        <tr>
                                            <td>{{ tier.min_quantity }}</td>
                                            <td>{{ tier.max_quantity|default:"—" }}</td>
                                            <td><strong>{{ tier.price_info }}</strong></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <div style="margin-top:1.2rem;text-align:center">
                                <a href="/#contact" class="cta-btn cta-primary">
                                    <i class="bi bi-envelope"></i> Request Custom Quote
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- FAQ TAB -->
                    {% if product.faqs.all %}
                    <div class="tab-pane" id="tab-faq" role="tabpanel" aria-labelledby="tab-btn-faq" tabindex="0">
                        <div class="content-card">
                            <h3><i class="bi bi-question-circle"></i> Frequently Asked Questions</h3>
                            {% for fq in product.faqs.all %}
                            <div class="faq-item">
                                <button type="button" class="faq-question" aria-expanded="false" onclick="toggleFaq(this)">
                                    <span>{{ fq.question }}</span>
                                    <i class="bi bi-chevron-down"></i>
                                </button>
                                <div class="faq-answer">
                                    <div class="faq-answer-inner">{{ fq.answer|linebreaksbr }}</div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar-sticky" style="order:2">
                <div class="sidebar-card">
                    <h4>Interested in {{ product.name }}?</h4>
                    <a href="/#contact" class="cta-btn cta-primary" style="width:100%;justify-content:center;margin-bottom:.7rem">
                        <i class="bi bi-envelope"></i> Request a Quote
                    </a>
                    <a href="{% url 'products' %}" class="cta-btn cta-outline" style="width:100%;justify-content:center">
                        <i class="bi bi-grid"></i> Browse Products
                    </a>
                </div>
                <div class="sidebar-card">
                    <h4>Need Help?</h4>
                    <div class="info-row"><i class="bi bi-telephone"></i><div><strong>Phone</strong><br>+91 9898837713</div></div>
                    <div class="info-row"><i class="bi bi-envelope-at"></i><div><strong>Email</strong><br>info@vasudevchemopharma.com</div></div>
                    <div class="info-row"><i class="bi bi-geo-alt"></i><div><strong>Location</strong><br>Ankleshwer, Gujarat, India</div></div>
                    {% if product.customer_support_contact %}
                    <hr class="section-divider">
                    <div class="info-row"><i class="bi bi-headset"></i><div><strong>Product Support</strong><br>{{ product.customer_support_contact|linebreaksbr }}</div></div>
                    {% endif %}
                </div>
                {% if product.manufacturer or product.batch_traceability or product.moq or product.lead_time or product.shelf_life %}
                <div class="sidebar-card">
                    <h4>Quick Facts</h4>
                    {% if product.manufacturer %}<div class="info-row"><i class="bi bi-building"></i><div><strong>Manufacturer</strong><br>{{ product.manufacturer }}</div></div>{% endif %}
                    {% if product.moq %}<div class="info-row"><i class="bi bi-stack"></i><div><strong>MOQ</strong><br>{{ product.moq }}</div></div>{% endif %}
                    {% if product.lead_time %}<div class="info-row"><i class="bi bi-clock"></i><div><strong>Lead Time</strong><br>{{ product.lead_time }}</div></div>{% endif %}
                    {% if product.shelf_life %}<div class="info-row"><i class="bi bi-calendar-check"></i><div><strong>Shelf Life</strong><br>{{ product.shelf_life }}</div></div>{% endif %}
                    {% if product.batch_traceability %}<div class="info-row"><i class="bi bi-qr-code"></i><div><strong>Batch Traceability</strong><br>{{ product.batch_traceability|linebreaksbr }}</div></div>{% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Related Products -->
{% if related_products %}
<section class="related-section">
    <div class="container">
        <h2 class="section-heading">Related Products</h2>
        <p class="section-subheading">Explore similar products in {{ product.category.label }}</p>
        <div class="related-grid">
            {% for rp in related_products %}
            <a href="{% url 'product_detail' slug=rp.slug %}" class="related-card">
                <div class="related-card-body">
                    <div class="r-icon">{{ rp.icon|default:"?" }}</div>
                    <div class="r-cat">{{ rp.category.label }}</div>
                    <h4>{{ rp.name }}</h4>
                    <p>{{ rp.description|truncatewords:18 }}</p>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    /* JS flag for conditional CSS */
    document.documentElement.classList.add('js');

    /* Tab switching with ARIA */
    (function () {
        var tabNav = document.querySelector('.htab-nav');
        if (!tabNav) return;
        var tabBtns = Array.prototype.slice.call(tabNav.querySelectorAll('.nav-link'));

        function activateTab(btn) {
            tabBtns.forEach(function (b) { b.classList.remove('active'); b.setAttribute('aria-selected', 'false'); });
            document.querySelectorAll('.tab-content-area .tab-pane').forEach(function (p) { p.classList.remove('active'); });
            btn.classList.add('active');
            btn.setAttribute('aria-selected', 'true');
            var panel = document.getElementById('tab-' + btn.getAttribute('data-tab'));
            if (panel) panel.classList.add('active');
            btn.focus();
        }

        tabBtns.forEach(function (btn) {
            btn.addEventListener('click', function () { activateTab(btn); });
        });

        /* Keyboard navigation for tabs */
        tabNav.addEventListener('keydown', function (e) {
            var idx = tabBtns.indexOf(document.activeElement);
            if (idx === -1) return;
            var newIdx = idx;
            if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                newIdx = (idx + 1) % tabBtns.length;
            } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                newIdx = (idx - 1 + tabBtns.length) % tabBtns.length;
            } else if (e.key === 'Home') {
                newIdx = 0;
            } else if (e.key === 'End') {
                newIdx = tabBtns.length - 1;
            } else {
                return;
            }
            e.preventDefault();
            activateTab(tabBtns[newIdx]);
        });
    })();

    /* Image gallery switching */
    function switchImage(thumb, url, alt) {
        var main = document.getElementById('mainImg');
        if (main) { main.src = url; main.alt = alt; }
        document.querySelectorAll('.gallery-thumbs .thumb').forEach(function (t) { t.classList.remove('active'); });
        thumb.classList.add('active');
    }

    /* FAQ accordion – dynamic max-height so long answers are never clipped */
    function toggleFaq(el) {
        var item = el.parentElement;
        var wasOpen = item.classList.contains('open');
        /* Close all items first */
        document.querySelectorAll('.faq-item').forEach(function (fi) {
            fi.classList.remove('open');
            fi.querySelector('.faq-question').setAttribute('aria-expanded', 'false');
            var ans = fi.querySelector('.faq-answer');
            if (ans) ans.style.maxHeight = '0px';
        });
        /* Open the clicked item */
        if (!wasOpen) {
            item.classList.add('open');
            el.setAttribute('aria-expanded', 'true');
            var answer = item.querySelector('.faq-answer');
            if (answer) {
                answer.style.maxHeight = answer.scrollHeight + 'px';
            }
        }
    }

    /* Fade-in on scroll */
    (function () {
        var fadeEls = document.querySelectorAll('.content-card, .sidebar-card, .related-card');
        if (window.IntersectionObserver) {
            var fadeObserver = new IntersectionObserver(function (entries) {
                entries.forEach(function (entry) {
                    if (entry.isIntersecting) entry.target.classList.add('visible');
                });
            }, { threshold: 0.08, rootMargin: '0px 0px -60px 0px' });
            fadeEls.forEach(function (el) { el.classList.add('fade-in'); fadeObserver.observe(el); });
        } else {
            fadeEls.forEach(function (el) { el.classList.add('visible'); });
        }
    })();
</script>
{% endblock %}
